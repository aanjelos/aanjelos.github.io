<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aanjelo's Board Game Library</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital,wght@0,400;1,400&display=swap');
        @import url('https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700,900&display=swap');
        
        body { font-family: 'Satoshi', sans-serif; background-color: #1F1F1F; color: #F1F1F1; }
        
        /* Font Utility Classes */
        .font-serif { font-family: 'Instrument Serif', serif; }
        .font-serif-italic { font-family: 'Instrument Serif', serif; font-style: italic; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F1F1F; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #C51728; }
        
        .accent-text { color: #C51728; }
        .accent-bg { background-color: #C51728; }
        .accent-border { border-color: #C51728; }
        
        /* Utility for ownership visual state */
        .not-owned { opacity: 0.5; filter: grayscale(0.8); }
        .not-owned:hover { opacity: 0.8; filter: grayscale(0); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURATION ---
        // Your Google Sheet CSV Link
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ058IHDO-lSXB4DKKkc8Lu1sU_eVVNsahQ4zAbleIRJgQbAAG1aYGVU1Pxxn3tvRH4FDR9GmSUft6H/pub?output=csv"; 
        
        // --- ICONS ---
        const Icons = {
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            LayoutGrid: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            SortAsc: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="M11 4h10"/><path d="M11 8h7"/><path d="M11 12h4"/></svg>,
            Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Hash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>,
            Dice: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>,
            Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Monitor: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
            DollarSign: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Tag: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>,
            Gift: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ShoppingBag: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Banknote: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,
            D20: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2 2 7l10 5 10-5-10-5Z"/><path d="m2 17 10 5 10-5M2 12l10 5 10-5"/></svg>
        };

        // --- HELPERS ---
        const calculateMyAverage = (base, subs) => {
            if (!base) return null;
            const baseVal = parseFloat(base) || 0;
            let numerator = baseVal * 10;
            let denominator = 10;
            let subCount = 0;
            
            ['j', 'k', 'm'].forEach(key => {
                const val = subs[key];
                if (val && !isNaN(parseFloat(val))) {
                    numerator += parseFloat(val);
                    denominator += 1;
                    subCount += 1;
                }
            });
            return (numerator / denominator).toFixed(1);
        };

        const calculateOverallAverage = (bgg, myAvg, friend) => {
            const values = [];
            if (bgg && !isNaN(parseFloat(bgg))) values.push(parseFloat(bgg));
            if (myAvg && !isNaN(parseFloat(myAvg))) values.push(parseFloat(myAvg));
            if (friend && !isNaN(parseFloat(friend))) values.push(parseFloat(friend));
            if (values.length === 0) return null;
            return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
        };

        // FLIPPED: 1 = Easiest, 10 = Hardest
        const getComplexityLabel = (val) => {
            if (!val) return '-';
            const v = Math.round(parseFloat(val));
            const labels = {
                1: "Sleepwalking", 2: "No Brainer", 3: "Casual", 4: "Light",
                5: "Moderate", 6: "Thinky", 7: "Brain Burner", 8: "Complex",
                9: "Heavy", 10: "Impossible"
            };
            return labels[Math.max(1, Math.min(10, v))] || "Moderate";
        };

        const getRatingColor = (rating) => {
            if (!rating) return 'text-[#F1F1F1]/40';
            const r = parseFloat(rating);
            if (r >= 8.5) return 'text-[#C51728] font-bold'; 
            if (r >= 8) return 'text-[#F1F1F1]';
            return 'text-[#F1F1F1]/70';
        };

        const parsePrice = (priceStr) => {
            if (!priceStr) return 0;
            return parseFloat(priceStr.toString().replace(/[^0-9.]/g, '')) || 0;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? dateStr : d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        const formatPlayers = (min, max) => {
            if (!min && !max) return '';
            if (min === max) return `${min}`;
            if (min && !max) return `${min}+`;
            if (!min && max) return `Up to ${max}`;
            return `${min}-${max}`;
        }

        // --- COMPONENTS ---

        const StatsPill = ({ icon: Icon, label, value, onClick, className = "" }) => (
            <div 
                onClick={onClick}
                className={`px-4 py-2 rounded-full border text-sm flex items-center gap-3 bg-[#F1F1F1]/5 border-[#F1F1F1]/10 text-[#F1F1F1]/60 transition-colors ${onClick ? 'cursor-pointer hover:bg-[#F1F1F1]/10' : ''} ${className}`}
            >
                <Icon className="w-4 h-4" />
                <span><span className="text-[#F1F1F1] font-bold">{value}</span> {label}</span>
            </div>
        );

        const ViewToggle = ({ active, onClick, icon: Icon }) => (
            <button 
                onClick={onClick}
                className={`p-3 rounded-xl transition-all ${active ? 'bg-[#F1F1F1] text-[#1F1F1F]' : 'text-[#F1F1F1]/40 hover:text-white hover:bg-[#F1F1F1]/10'}`}
            >
                <Icon className="w-4 h-4" />
            </button>
        );

        function GameCard({ game, viewMode, onOpenDetail }) {
            const isGrid = viewMode === 'grid';
            const isOwned = game.owned;
            
            if (!isGrid) {
                return (
                    <div 
                        onClick={() => onOpenDetail(game)}
                        className={`group flex items-center gap-6 border p-4 rounded-2xl transition-all cursor-pointer ${isOwned ? 'bg-[#F1F1F1]/5 border-[#F1F1F1]/5 hover:bg-[#F1F1F1]/10 hover:border-[#C51728]/30' : 'bg-[#F1F1F1]/[0.02] border-[#F1F1F1]/5 not-owned'}`}
                    >
                        <div className="w-16 h-16 rounded-xl overflow-hidden shrink-0 bg-[#000]/20 flex items-center justify-center relative">
                            {game.image ? (
                                <img src={game.image} alt={game.name} className="w-full h-full object-cover" />
                            ) : (
                                <Icons.Box className="w-6 h-6 text-[#F1F1F1]/20"/>
                            )}
                            
                            {/* REMOVED: Red dot indicator from list view */}
                            
                            {game.expansions?.length > 0 && (
                                <div className="absolute top-1 right-1 bg-[#C51728] w-2 h-2 rounded-full" title="Has Expansions" />
                            )}
                        </div>
                        
                        <div className="flex-1 min-w-0">
                            <h3 className={`font-serif-italic text-xl truncate transition-colors flex items-center gap-2 ${isOwned ? 'text-[#F1F1F1] group-hover:text-[#C51728]' : 'text-[#F1F1F1]/50'}`}>
                                {game.name}
                                {game.expansions?.length > 0 && <Icons.Layers className="w-4 h-4 text-[#F1F1F1]/30" />}
                            </h3>
                            <div className="flex items-center gap-4 text-sm text-[#F1F1F1]/40 mt-1">
                                {game.playTime && <span className="flex items-center gap-1.5"><Icons.Clock className="w-3.5 h-3.5" />{game.playTime}m</span>}
                                {(game.minPlayers || game.maxPlayers) && <span className="flex items-center gap-1.5"><Icons.Users className="w-3.5 h-3.5" />{formatPlayers(game.minPlayers, game.maxPlayers)}</span>}
                                {game.dateAcquired && <span className="flex items-center gap-1.5"><Icons.Calendar className="w-3.5 h-3.5" />{formatDate(game.dateAcquired)}</span>}
                            </div>
                        </div>

                        <div className="flex items-center gap-2 sm:gap-8 pr-4">
                            <div className="hidden sm:flex flex-col items-center min-w-[3rem]">
                                <span className="text-[10px] text-[#F1F1F1]/30 uppercase font-bold tracking-widest mb-1">BGG</span>
                                <span className="font-bold text-[#F1F1F1]/60">{game.bggRating || '-'}</span>
                            </div>
                            <div className="hidden sm:flex flex-col items-center min-w-[3rem]">
                                <span className="text-[10px] text-[#F1F1F1]/30 uppercase font-bold tracking-widest mb-1">Friend</span>
                                <span className="font-bold text-[#F1F1F1]/60">{game.friendRating || '-'}</span>
                            </div>
                            <div className="flex flex-col items-center min-w-[3rem]">
                                <span className="text-[10px] text-[#F1F1F1]/30 uppercase font-bold tracking-widest mb-1">My Avg</span>
                                <span className="text-xl text-[#F1F1F1]">{game.calculatedMyAvg || '-'}</span>
                            </div>
                            <div className="flex flex-col items-center min-w-[3rem]">
                                <span className="text-[10px] text-[#F1F1F1]/30 uppercase font-bold tracking-widest mb-1">Overall</span>
                                <span className="font-bold text-[#C51728]">{game.calculatedOverallAvg || '-'}</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div 
                    onClick={() => onOpenDetail(game)}
                    className={`group relative border rounded-3xl overflow-hidden transition-all duration-300 cursor-pointer flex flex-col h-full ${isOwned ? 'bg-[#F1F1F1]/5 border-[#F1F1F1]/5 hover:border-[#C51728]/40 hover:shadow-2xl hover:shadow-[#C51728]/10' : 'bg-[#F1F1F1]/[0.02] border-[#F1F1F1]/5 not-owned'}`}
                >
                    <div className="relative w-full aspect-[4/3] bg-[#000]/30 overflow-hidden">
                        {game.image ? (
                            <img src={game.image} alt={game.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80 group-hover:opacity-100" />
                        ) : (
                            <div className="absolute inset-0 flex items-center justify-center text-[#F1F1F1]/10">
                                <Icons.Box className="w-12 h-12" />
                            </div>
                        )}
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80" />
                        
                        {/* REMOVED: Trophy icon and circle on grid view */}
                        
                        {game.expansions?.length > 0 && (
                            <div className="absolute top-3 right-3 flex flex-col gap-1 items-end">
                                <div className="bg-[#1F1F1F]/80 backdrop-blur text-[#F1F1F1] text-[10px] px-2 py-1 rounded-full border border-[#F1F1F1]/10 flex items-center gap-1">
                                    <Icons.Layers className="w-3 h-3" /> +{game.expansions.length}
                                </div>
                            </div>
                        )}
                        
                        {!isOwned && (
                            <div className="absolute top-3 left-3 bg-[#000]/60 backdrop-blur text-[#F1F1F1]/60 text-[10px] px-2 py-1 rounded-full border border-[#F1F1F1]/10 uppercase font-bold tracking-widest">
                                Not Owned
                            </div>
                        )}
                    </div>

                    {/* Adjusted content section to sit right on top of the border */}
                    <div className="flex-1 flex flex-col justify-end relative z-10 -mt-20"> 
                        {/* Game Name adjusted to sit right on top of the black box content */}
                        <div className="px-6 pb-2 min-h-[60px] flex items-end justify-start">
                            <h3 className={`font-serif-italic text-2xl leading-tight mb-2 transition-colors drop-shadow-md line-clamp-2 ${isOwned ? 'text-[#F1F1F1] group-hover:text-[#C51728]' : 'text-[#F1F1F1]/50'}`} title={game.name}>
                                {game.name}
                            </h3>
                        </div>

                        {/* Black box scores section */}
                        <div className="bg-[#1F1F1F] p-4 pt-4 border-t border-[#F1F1F1]/10 rounded-b-3xl">
                            <div className="grid grid-cols-3 gap-2">
                                <div className="text-center">
                                    <div className="text-[10px] text-[#F1F1F1]/40 uppercase font-bold tracking-widest mb-1.5">BGG</div>
                                    <div className="text-xl font-bold text-[#F1F1F1]/60">{game.bggRating || '-'}</div>
                                </div>
                                <div className="text-center border-l border-[#F1F1F1]/10">
                                    <div className="text-[10px] text-[#F1F1F1]/40 uppercase font-bold tracking-widest mb-1.5">My Avg</div>
                                    <div className="text-xl text-[#F1F1F1]">{game.calculatedMyAvg || '-'}</div>
                                </div>
                                <div className="text-center border-l border-[#F1F1F1]/10">
                                    <div className="text-[10px] text-[#F1F1F1]/40 uppercase font-bold tracking-widest mb-1.5">Overall</div>
                                    <div className="text-xl font-bold text-[#C51728]">{game.calculatedOverallAvg || '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function GameDetailModal({ game, onClose }) {
            if (!game) return null;
            const isOwned = game.owned;

            // Stop click propagation inside the modal
            const handleContentClick = (e) => {
                e.stopPropagation();
            }

            return (
                <div 
                    className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-[#000]/80 backdrop-blur-sm"
                    onClick={onClose} 
                >
                    <div 
                        className="bg-[#1F1F1F] border border-[#F1F1F1]/10 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col md:flex-row overflow-hidden animate-in fade-in zoom-in-95 duration-200"
                        onClick={handleContentClick}
                    >
                        
                        {/* Left: Quick Stats */}
                        <div className="md:w-1/3 bg-[#000]/40 relative min-h-[300px] md:min-h-0">
                            <div className="absolute inset-0">
                                {game.image ? (
                                    <img src={game.image} alt={game.name} className="w-full h-full object-cover opacity-60" />
                                ) : (
                                    <div className="w-full h-full" />
                                )}
                                <div className="absolute inset-0 bg-gradient-to-t from-[#1F1F1F] via-[#1F1F1F]/40 to-transparent" />
                            </div>
                            <div className="relative p-8 h-full flex flex-col justify-end">
                                <h2 className={`font-serif-italic text-4xl mb-3 leading-none drop-shadow-xl ${isOwned ? 'text-white' : 'text-[#F1F1F1]/50'}`}>{game.name}</h2>
                                <div className="flex gap-3 text-sm text-[#F1F1F1]/60 mb-8 font-medium flex-wrap">
                                    {game.playTime && <span className="flex items-center gap-1.5 bg-[#F1F1F1]/5 px-3 py-1.5 rounded-full backdrop-blur-md"><Icons.Clock className="w-4 h-4" /> {game.playTime}m</span>}
                                    {(game.minPlayers || game.maxPlayers) && <span className="flex items-center gap-1.5 bg-[#F1F1F1]/5 px-3 py-1.5 rounded-full backdrop-blur-md"><Icons.Users className="w-4 h-4" /> {formatPlayers(game.minPlayers, game.maxPlayers)}</span>}
                                    {game.source && <span className="flex items-center gap-1.5 bg-[#F1F1F1]/5 px-3 py-1.5 rounded-full backdrop-blur-md">
                                        {/* CHANGED: Different icons for Bought (Banknote) vs Gifted (Gift) */}
                                        {game.source === 'Bought' ? <Icons.Banknote className="w-4 h-4" /> : <Icons.Gift className="w-4 h-4" />} 
                                        {game.source}
                                    </span>}
                                    {game.status && <span className="flex items-center gap-1.5 bg-[#F1F1F1]/5 px-3 py-1.5 rounded-full backdrop-blur-md"><Icons.Tag className="w-4 h-4" /> {game.status}</span>}
                                </div>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-[#F1F1F1]/5 backdrop-blur-md p-4 rounded-2xl border border-[#F1F1F1]/10">
                                        <div className="text-[10px] text-[#F1F1F1]/40 uppercase font-bold tracking-widest mb-1">My Avg</div>
                                        <div className="text-3xl font-bold text-[#F1F1F1]">{game.calculatedMyAvg || '-'}</div>
                                    </div>
                                    <div className="bg-[#F1F1F1]/5 backdrop-blur-md p-4 rounded-2xl border border-[#F1F1F1]/10">
                                        <div className="text-[10px] text-[#F1F1F1]/40 uppercase font-bold tracking-widest mb-1">Overall</div>
                                        <div className="text-3xl font-bold text-[#C51728]">{game.calculatedOverallAvg || '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Right: Detailed Breakdown */}
                        <div className="flex-1 p-8 bg-[#1F1F1F] overflow-y-auto">
                            <div className="flex justify-end gap-2 mb-8">
                                <button onClick={onClose} className="p-2.5 hover:bg-[#F1F1F1]/5 rounded-full text-[#F1F1F1]/40 hover:text-white transition-colors cursor-pointer text-3xl font-thin leading-none">
                                    &times;
                                </button>
                            </div>

                            <div className="space-y-10">
                                {/* Metadata Row */}
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 p-4 bg-[#F1F1F1]/5 rounded-2xl border border-[#F1F1F1]/5 text-xs">
                                    <div>
                                        <div className="text-[#F1F1F1]/40 mb-1">Acquired</div>
                                        <div className="text-[#F1F1F1]">{formatDate(game.dateAcquired) || '-'}</div>
                                    </div>
                                    <div>
                                        <div className="text-[#F1F1F1]/40 mb-1">Paid</div>
                                        <div className="text-[#F1F1F1]">Rs. {parseInt(game.price).toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <div className="text-[#F1F1F1]/40 mb-1">MSRP</div>
                                        <div className="text-[#F1F1F1]/60">Rs. {parseInt(game.msrp).toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <div className="text-[#F1F1F1]/40 mb-1">Status</div>
                                        <div className={`${isOwned ? 'text-emerald-400' : 'text-red-400'}`}>{isOwned ? 'Owned' : 'Gone'}</div>
                                    </div>
                                </div>

                                {/* Calculation Breakdown */}
                                <section>
                                    <h3 className="text-xs font-bold text-[#F1F1F1]/40 tracking-widest mb-6 flex items-center gap-2">
                                        <Icons.Calculator className="w-4 h-4" /> Scoring Breakdown
                                    </h3>
                                    
                                    <div className="bg-[#F1F1F1]/5 rounded-3xl p-8 border border-[#F1F1F1]/5 space-y-8">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="text-[#F1F1F1] font-bold text-lg flex items-center gap-3">
                                                    Gameplay
                                                    <span className="text-[10px] bg-[#C51728]/20 text-[#C51728] px-2 py-0.5 rounded-full border border-[#C51728]/30 font-bold tracking-wide">BASE</span>
                                                </div>
                                                <div className="text-xs text-[#F1F1F1]/40 mt-1.5">Primary weighted factor (x10)</div>
                                            </div>
                                            <div className="text-4xl font-serif-italic text-white">{game.baseScore || '-'}</div>
                                        </div>

                                        <div className="h-px bg-[#F1F1F1]/10 w-full" />

                                        <div className="grid grid-cols-2 gap-4">
                                            {[
                                                { l: 'Portability', v: game.subScores?.j, i: Icons.Briefcase },
                                                { l: 'Aesthetics', v: game.subScores?.m, i: Icons.Eye }
                                            ].map((s, i) => (
                                                <div key={i} className={`p-4 rounded-2xl border ${s.v ? 'bg-[#F1F1F1]/5 border-[#F1F1F1]/10' : 'bg-transparent border-[#F1F1F1]/5 opacity-30'} transition-colors`}>
                                                    <div className="text-[10px] text-[#F1F1F1]/40 tracking-widest truncate mb-2 flex items-center gap-1.5">
                                                        <s.i className="w-3 h-3" />
                                                        {s.l}
                                                    </div>
                                                    <div className="flex items-baseline gap-2">
                                                        <span className="text-2xl font-serif-italic text-[#F1F1F1]">{s.v || '-'}</span>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            <div className={`p-4 rounded-2xl border ${game.subScores?.k ? 'bg-[#F1F1F1]/5 border-[#F1F1F1]/10' : 'bg-transparent border-[#F1F1F1]/5 opacity-30'} transition-colors`}>
                                                <div className="text-[10px] text-[#F1F1F1]/40 tracking-widest truncate mb-2 flex items-center gap-1.5">
                                                    <Icons.Zap className="w-3 h-3" />
                                                    Complexity
                                                </div>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-lg font-serif-italic text-[#F1F1F1] leading-tight">
                                                        {game.subScores?.k ? `${Math.round(game.subScores.k)} - ${getComplexityLabel(game.subScores.k)}` : '-'}
                                                    </span>
                                                </div>
                                            </div>

                                            {/* ADDED BACK: Player Count Card */}
                                            <div className={`p-4 rounded-2xl border ${game.minPlayers || game.maxPlayers ? 'bg-[#F1F1F1]/5 border-[#F1F1F1]/10' : 'bg-transparent border-[#F1F1F1]/5 opacity-30'} transition-colors`}>
                                                <div className="text-[10px] text-[#F1F1F1]/40 tracking-widest truncate mb-2 flex items-center gap-1.5">
                                                    <Icons.Users className="w-3 h-3" />
                                                    Players
                                                </div>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-lg font-serif-italic text-[#F1F1F1] leading-tight">
                                                        {formatPlayers(game.minPlayers, game.maxPlayers)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                
                                {game.expansions?.length > 0 && (
                                    <section>
                                        <h3 className="text-xs font-bold text-[#F1F1F1]/40 tracking-widest mb-6 flex items-center gap-2">
                                            <Icons.Layers className="w-4 h-4" /> Expansions
                                        </h3>
                                        <div className="space-y-3">
                                            {game.expansions.map((exp, i) => (
                                                <div key={i} className="bg-[#F1F1F1]/5 p-4 rounded-xl border border-[#F1F1F1]/5 flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-1 h-8 bg-[#C51728] rounded-full" />
                                                        <div>
                                                            <div className="text-[#F1F1F1] font-bold">{exp.name}</div>
                                                            <div className="text-xs text-[#F1F1F1]/40">BGG: {exp.bggRating} â€¢ Friend: {exp.friendRating}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-xl font-serif-italic text-[#F1F1F1] opacity-60">
                                                        {calculateOverallAverage(exp.bggRating, calculateMyAverage(exp.baseScore, exp.subScores || {})?.value, exp.friendRating) || '-'}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                )}

                                <section>
                                    <h3 className="text-xs font-bold text-[#F1F1F1]/40 tracking-widest mb-6 flex items-center gap-2">
                                        <Icons.Monitor className="w-4 h-4" /> External Factors
                                    </h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-[#F1F1F1]/5 p-6 rounded-3xl border border-[#F1F1F1]/5 flex justify-between items-center">
                                            <div>
                                                <div className="text-[#F1F1F1]/40 text-xs mb-1 font-bold tracking-widest">BGG Rating</div>
                                                <div className="text-xs text-[#F1F1F1]/30">Community</div>
                                            </div>
                                            <div className="text-3xl font-serif-italic text-[#F1F1F1]">{game.bggRating || '-'}</div>
                                        </div>
                                        <div className="bg-[#F1F1F1]/5 p-6 rounded-3xl border border-[#F1F1F1]/5 flex justify-between items-center">
                                            <div>
                                                <div className="text-[#F1F1F1]/40 text-xs mb-1 font-bold tracking-widest">Friend Rating</div>
                                                <div className="text-xs text-[#F1F1F1]/30">Secondary</div>
                                            </div>
                                            <div className="text-3xl font-serif-italic text-[#F1F1F1]">{game.friendRating || '-'}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-6 p-4 bg-[#F1F1F1]/5 rounded-2xl border border-[#F1F1F1]/5">
                                        <h4 className="text-xs font-bold text-[#F1F1F1]/40 tracking-widest mb-2">How Overall is Calculated</h4>
                                        <p className="text-xs text-[#F1F1F1]/60 leading-relaxed">
                                            The Overall Score is a simple average of three main components:
                                            <br/><br/>
                                            1. <strong>BGG Rating:</strong> The global community rating from BoardGameGeek.
                                            <br/>
                                            2. <strong>My Average:</strong> My personal weighted score derived from Gameplay (x10 weight) plus Portability, Complexity, and Aesthetics.
                                            <br/>
                                            3. <strong>Friend Rating:</strong> The rating given by my friends who have played it.
                                        </p>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [games, setGames] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('overall'); 
            const [sortOrder, setSortOrder] = useState('desc'); 
            const [viewMode, setViewMode] = useState('grid'); // Default view changed to 'grid'
            const [selectedGame, setSelectedGame] = useState(null);
            const [showMSRP, setShowMSRP] = useState(false);

            useEffect(() => {
                const fetchData = () => {
                    const url = GOOGLE_SHEET_URL;
                    
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const rawData = results.data;
                            
                            // Process Nesting
                            const gameMap = {};
                            const rootGames = [];

                            // First pass: Create objects
                            rawData.forEach(row => {
                                if(!row.Game) return;
                                const game = {
                                    id: row.Game, 
                                    name: row.Game,
                                    parent: row['Parent Game'],
                                    owned: row.Owned === 'TRUE',
                                    status: row.Status,
                                    dateAcquired: row['Acquired Date'],
                                    price: parsePrice(row.Price),
                                    msrp: parsePrice(row.MSRP),
                                    source: row.Source,
                                    bggRating: row['BGG Rating'],
                                    baseScore: row.Gameplay,
                                    playTime: row['Play Time'],
                                    minPlayers: row['Min Players'],
                                    maxPlayers: row['Max Players'],
                                    image: row['Image'],
                                    friendRating: row['Friend Rating'],
                                    subScores: {
                                        j: row.Portability, // J
                                        k: row.Complexity, // K
                                        m: row.Aesthetics // M
                                    },
                                    expansions: []
                                };
                                
                                gameMap[game.name] = game;
                                
                                if (!game.parent) {
                                    rootGames.push(game);
                                }
                            });

                            // Second pass: Nest expansions
                            rawData.forEach(row => {
                                if (row['Parent Game'] && gameMap[row['Parent Game']]) {
                                    gameMap[row['Parent Game']].expansions.push(gameMap[row.Game]);
                                }
                            });

                            setGames(rootGames);
                            setLoading(false);
                        },
                        error: (err) => {
                            console.error("CSV Parse Error:", err);
                            setLoading(false);
                        }
                    });
                };

                fetchData();
            }, []);

            const filteredGames = useMemo(() => {
                let result = games.map(game => {
                    const myAvgObj = calculateMyAverage(game.baseScore, game.subScores || {});
                    const overallAvg = calculateOverallAverage(game.bggRating, myAvgObj, game.friendRating);
                    
                    return { 
                        ...game, 
                        calculatedMyAvg: myAvgObj,
                        calculatedOverallAvg: overallAvg 
                    };
                });

                if (searchTerm) {
                    result = result.filter(g => g.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }

                result.sort((a, b) => {
                    let valA, valB;
                    // Sort logic
                    switch(sortBy) {
                        case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
                        case 'myRating': valA = parseFloat(a.calculatedMyAvg || 0); valB = parseFloat(b.calculatedMyAvg || 0); break;
                        case 'bggRating': valA = parseFloat(a.bggRating || 0); valB = parseFloat(b.bggRating || 0); break;
                        case 'overall': valA = parseFloat(a.calculatedOverallAvg || 0); valB = parseFloat(b.calculatedOverallAvg || 0); break;
                        case 'complexity': valA = parseFloat(a.subScores?.k || 0); valB = parseFloat(b.subScores?.k || 0); break;
                        case 'aesthetic': valA = parseFloat(a.subScores?.m || 0); valB = parseFloat(b.subScores?.m || 0); break;
                        case 'portability': valA = parseFloat(a.subScores?.j || 0); valB = parseFloat(b.subScores?.j || 0); break;
                        case 'playtime': valA = parseInt(a.playTime || 0); valB = parseInt(b.playTime || 0); break;
                        case 'players': valA = parseInt(a.maxPlayers || 0); valB = parseInt(b.maxPlayers || 0); break;
                        case 'date': 
                            valA = new Date(a.dateAcquired || 0).getTime();
                            valB = new Date(b.dateAcquired || 0).getTime();
                            break;
                        default: return 0;
                    }
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                return result;
            }, [games, searchTerm, sortBy, sortOrder]);

            const stats = useMemo(() => {
                const totalGames = games.length;
                
                // Calculate Total Price (Including Expansions)
                let totalPrice = 0;
                let totalMSRP = 0;

                // We iterate over the 'rootGames' (which is what 'games' state holds)
                games.forEach(game => {
                    // Add main game price
                    totalPrice += game.price || 0;
                    totalMSRP += game.msrp || 0;

                    // Add expansion prices
                    if (game.expansions && game.expansions.length > 0) {
                        game.expansions.forEach(exp => {
                            totalPrice += exp.price || 0;
                            totalMSRP += exp.msrp || 0;
                        });
                    }
                });

                return { 
                    total: totalGames, 
                    totalPrice: showMSRP ? totalMSRP : totalPrice 
                };
            }, [games, showMSRP]);

            return (
                <div className="min-h-screen bg-[#1F1F1F] text-[#F1F1F1] selection:bg-[#C51728]/30 selection:text-white">
                    <nav className="border-b border-[#F1F1F1]/5 bg-[#1F1F1F]/95 backdrop-blur-xl sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <h1 className="text-3xl font-serif-italic tracking-wide text-[#F1F1F1]">Aanjelo's Board Games Library</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <StatsPill icon={Icons.Hash} label="Games" value={stats.total} />
                                <StatsPill 
                                    icon={Icons.DollarSign} 
                                    label={showMSRP ? "Value (MSRP)" : "Spent"} 
                                    value={`Rs. ${stats.totalPrice.toLocaleString()}`} 
                                    onClick={() => setShowMSRP(!showMSRP)}
                                    className="cursor-pointer hover:bg-[#F1F1F1]/10"
                                />
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-6 py-12">
                        {/* Controls */}
                        <div className="flex flex-col md:flex-row gap-6 mb-12">
                            <div className="relative flex-1 group">
                                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-[#F1F1F1]/30 group-focus-within:text-[#C51728]"><Icons.Search /></span>
                                <input type="text" placeholder="Search your library..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} 
                                    className="w-full bg-[#F1F1F1]/5 border border-[#F1F1F1]/5 rounded-2xl pl-12 pr-6 py-4 focus:outline-none focus:ring-1 focus:ring-[#C51728] focus:bg-[#F1F1F1]/10 transition-all placeholder:text-[#F1F1F1]/30 text-lg" />
                            </div>
                            <div className="flex gap-3 shrink-0">
                                <div className="bg-[#F1F1F1]/5 rounded-2xl p-1 flex items-center border border-[#F1F1F1]/5">
                                    <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="bg-transparent border-none text-sm focus:ring-0 text-[#F1F1F1] px-4 py-2 cursor-pointer outline-none">
                                        <option value="overall" className="bg-[#1F1F1F]">Overall Avg</option>
                                        <option value="name" className="bg-[#1F1F1F]">Name</option>
                                        <option value="date" className="bg-[#1F1F1F]">Date Acquired</option>
                                        <option value="myRating" className="bg-[#1F1F1F]">My Rating</option>
                                        <option value="bggRating" className="bg-[#1F1F1F]">BGG Rating</option>
                                        <option value="complexity" className="bg-[#1F1F1F]">Complexity</option>
                                        <option value="aesthetic" className="bg-[#1F1F1F]">Aesthetic</option>
                                        <option value="portability" className="bg-[#1F1F1F]">Portability</option>
                                        <option value="playtime" className="bg-[#1F1F1F]">Play Time</option>
                                        <option value="players" className="bg-[#1F1F1F]">Max Players</option>
                                    </select>
                                    <div className="w-px h-6 bg-[#F1F1F1]/10 mx-1" />
                                    <button onClick={() => setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')} className="p-2 hover:bg-[#F1F1F1]/10 rounded-lg transition-colors text-[#F1F1F1]/60 hover:text-white">
                                        <Icons.SortAsc className={sortOrder === 'desc' ? 'rotate-180' : ''} />
                                    </button>
                                </div>
                                <div className="bg-[#F1F1F1]/5 rounded-2xl p-1 flex items-center border border-[#F1F1F1]/5">
                                    <ViewToggle active={viewMode === 'grid'} onClick={() => setViewMode('grid')} icon={Icons.LayoutGrid} />
                                    <ViewToggle active={viewMode === 'list'} onClick={() => setViewMode('list')} icon={Icons.List} />
                                </div>
                            </div>
                        </div>

                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-32 text-[#F1F1F1]/40">
                                <div className="w-8 h-8 border-2 border-[#C51728] border-t-transparent rounded-full animate-spin mb-4" />
                                <p className="text-sm">Loading collection...</p>
                            </div>
                        ) : (
                            <div className={viewMode === 'grid' ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" : "flex flex-col gap-3"}>
                                {filteredGames.map(game => (
                                    <GameCard key={game.id} game={game} viewMode={viewMode} onOpenDetail={setSelectedGame} />
                                ))}
                                {filteredGames.length === 0 && <div className="col-span-full py-24 text-center text-[#F1F1F1]/40">No games found</div>}
                            </div>
                        )}
                    </main>

                    <GameDetailModal game={selectedGame} onClose={() => setSelectedGame(null)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>